### 请详细阐述微服务架构在项目中的应用，以及如何保证服务之间的解耦和通信效率？

 在微服务架构中，通过定义清晰的API接口和服务边界来保证解耦。通信效率方面，使用了轻量级的RESTful API或gRPC，同时利用服务发现和负载均衡来优化

### 在使用DDD（领域驱动设计）架构时，如何划分领域模型和界限上下文？请举例说明。

  在DDD中，根据业务需求将系统分为多个界限上下文，每个界限上下文对应一个领域模型。例如，订单管理是一个界限上下文，用户管理是另外一个。

### 敏感词过滤是如何实现的？如何保证过滤的准确性和性能？

敏感词过滤使用了Github上的开源敏感词库......

### 在对接ChatGLM大模型时，如何处理Session会话模型？有哪些挑战和解决方案？

处理Session会话模型时，我们为每一个用户分配一个唯一的Session ID，并在服务端维护session状态，挑战包括状态管理和并发处理，解决方案包括使用分布式缓存和一致性哈希。

### 请详细描述独立SDK的设计思路和实现过程，以及如何保证SDK的稳定性和可扩展性？

独立设计SDK时，我们遵循了模块化和单一职责原则，实现过程中，我们进行了充分的单元测试

### 使用OkHttp3框架完成模型对接时，如何优化网络请求的性能和异常处理？

使用OkHttp3时，我们通过连接池服用连接，请求合并、响应压缩等技术优化性能。异常处理方面，我们采用了签名验证、加密传输等手段

### 在实现支付宝扫码支付过程中，如何保证交易的一致性和安全性？

保证交易一致性通过实现分布式事务处理，如使用TCC模型。安全性方面，我们采用了签名验证、加密传输等手段

### 请阐述使用Redis分布式锁防止商品超卖的原理和实现细节？

Redis分布式锁通过SETNX命令实现，结合EXPIRE设置过期时间来防止锁的永久占用。实现细节包括锁的续期和异常释放。

### 项目中如何实现异步发货和掉单补货机制？

异步发货通过消息队列实现，调单补货通过定时任务和状态检查机制来处理。

### 抽象思想、设计模式和设计原则在项目中具体体现在哪些方面？请举例说明。

抽象思想体现在将共通逻辑抽象为工具类或者服务，设计模式如工厂模式、策略模式用于不同场景，设计原则如开闭原则、里氏替换原则指导代码编写。

### 如何确保微服务的可观测性？有哪些监控手段和工具？

客观车型通过继承日志、监控和链路追踪系统来实现。监控手段包括Prometheus和Grafana

### 项目中如何处理跨服务的事务管理？

跨服务事务管理使用了分布式事务解决方案，如Seata或基于消息队列的最终一致性方案

### 请介绍MyBatis在项目中的应用场景，以及如何优化SQL性能？

Mybatis主要用于数据库操作，通过配置SQL映射和动态SQL优化性能，使用PageHelper实现分页查询

### Redis/Guava在项目中是如何使用的？有哪些典型的应用场景？

redis用于缓存热点数据、分布式锁、计数器等。guava用于本地缓存和限流

### 如何保证OpenAI大模型的响应速度和稳定性？

保证大模型响应速度通过优化网络请求、使用负载均衡和缓存策略。稳定性通过**服务熔断和降级处理。**

### 项目中有哪些性能优化措施？如何评估优化效果？

性能优化措施包括数据库索引优化、缓存策略、代码层面的性能调优。评估优化效果通过压力测试和性能监控。

### 请阐述如何实现公众号鉴权机制，以及如何防止恶意攻击？

公众号鉴权通过OAuth2.0协议实现，防止恶意工具通过限制请求频率、验证码机制和黑白名单策略。

### 在微服务架构下，如何实现服务的注册与发现？

服务注册与发现通过Consul、EureKa或Nacos等注册中心实现。

### 项目中有哪些安全措施？如何防范常见的网络攻击？

安全措施包括使用HTTPS、API密钥、身份验证、授权和日志审计。网络攻击如**CSRF XSS**

### 请谈谈在项目开发过程中遇到的最大的技术挑战，以及如何解决的？

最大的技术挑战可能时实现高并发的支付流程，解决方案包括优化数据库事务、使用消息队列削峰减谷、分布式锁等。



### 在微服务架构中，你是如何划分职责边界的？具体涉及到哪些微服务模块？为什么选择这种划分方式？

在微服务架构中，职责边界的划分是基于业务领域进行的。具体模块可能包含用户服务，订单服务，微信鉴权服务，模型服务。这种划分方式是为了确保每个服务都有明确的职责，便于独立部署和维护，同时降低系统间的耦合

### 请详细说明DDD架构API在该项目中的应用，并举例说明其中一个功能域的设计和实现。

DDD架构API在该项目中的应用体现在将业务逻辑封装为领域服务，通过应用服务暴露给外部。例如，订单域的设计可能包括订单实体、订单值对象、订单仓储接口和订单领域服务。实现时，定义了订单创建、更新、查询等操作，并通过API暴露这些功能。

### 如何确保敏感词过滤的效率和准确性？采用了哪些算法和数据结构？

确保敏感词过滤的效率和准确定，采用了Trie树和哈希表结合的算法，以及Aho-corasick多模式匹配算法。数据结构方面，使用Trie树存储关键词，哈希表用于快速定位。

### 在对接ChatGLM大模型的独立SDK设计中，你是如何管理会话模型的？会话状态如何保持？有考虑并发情况下的性能吗？

在独立SDK设计中，会话模型通过唯一标识符UUID进行管理。会话状态保持通过内存中的会话存储实现，并定期持久化到数据库。并发情况下，通过线程安全和锁机制确保性能。

### 你如何设计并实现了支付宝扫码支付的核心流程？

支付宝扫码支付的核心流程包括订单创建、支付请求、支付结果通知和订单状态更新。

### 使用Redis分布式锁的具体方式是什么？是否考虑到高并发场景？

使用redis分布式锁的方式是通过SETNX命令设置锁，并设置过期时间。高并发场景下，通过优化锁的粒度和避免长时间持有锁来处理。

### 你在项目中使用了哪些设计模式和设计原则？分别在哪些场景下使用，具体如何落地？

在项目中使用了工厂模式、策略模式、单例模式等设计模式，以及单一职责、开闭原则等设计原则。；例如：工厂模式用于创建不同类型的支付处理器，策略模式用于切换不同的敏感词过滤算法和各种模型的选择，和不同过滤逻辑的选择。

### 项目中采用了模块化设计构建应用，那么在模块之间的通信和数据传递上，你是如何设计的？

模块间的通信和数据传递通过定义清洗的API接口实现，使用RESTful或gRPC协议。数据传递上，采用序列化和反序列化技术，确保数据的完整性和一致性。

### 请描述一下你在实现大模型对接的过程中，所遇到的技术挑战，以及你是如何解决的？

实现大模型对接的技术挑战包括处理高并发请求和保证低延迟响应，解决方案包括使用负载均衡、缓存策略和异步处理。

### 对于使用OkHttp3框架完成模型对接的决策，你是如何权衡和选择的？相比其他框架，它的优势和劣势是什么？

选择OkHttp3框架是因为其高效的连接池管理、请求合并和易于定制。相比于其他框架，OkHttp3的优势在于性能和灵活性，劣势可能是在某些复杂场景下定制化成本较高。

### 在项目的扩展性设计上，你是如何预估和平衡新需求引入对系统的影响？

在扩展性设计上，通过微服务框架的天然优势，以及使用配置中心和动态服务发现机制，预估和平衡新需求引入的影响。

### 在项目中使用了Redis/Guava，具体涉及到哪些场景？相比较而言，Redis和Guava在哪些场景下更适合？

Redis用于缓存和分布式锁，消息队列等场景，Guava用于本地缓存、限流等。Redis适合分布式环境，Guava适合单机环境。

### 项目中有提到使用了抽象的思想，请举例说明一个具体的场景，并展示它是如何解决问题的。

抽象思想的一个场景是将支付逻辑抽象为支付网关，解决了接入多种支付方式的问题，通过统一接口降低系统复杂度。

### 你如何测试和验证生成式服务的稳定性和性能？有哪些具体的测试策略和工具？

测试生成式服务的稳定性和性能，采用了压力测试、负载测试和性能监控工具，如Prometheus

### 你在项目中有考虑过容错和事务一致性的设计吗？具体是如何解决的？

容错和事务一致性的设计通过实现重试机制、服务熔断、分布式事务管理如Seate来解决。

### 项目中涉及到大量的模型处理，你是如何管理模型版本控制和升级的？是否涉及到模型训练和部署的过程？

管理模型版本控制和升级通过版本化的API和配置管理，涉及模型训练和部署的过程，通常使用CI/CD管道自动化。

### 请描述一下你在项目优化中的具体工作和效果，以及优化的思路和方法。

项目优化工作包括数据库索引优化、缓存策略优化、代码重构等。优化思路是性能平静分析、测试验证和持续改进。

### 项目中使用了SpringBoot和MyBatis框架，你对其中一个框架的源码分析和优化有哪些实践和经验？

对SpringBoot的源码分析和优化可能包括自定义自动配置、扩展SpringBoot的启动流程、优化Bean的加载等。

### 对于对接不同方式的接入的提及，你是如何考虑到兼容性问题的？具体的兼容性测试方案和策略是什么？

对接不同方式的接入兼容性考虑，通过抽象层和适配器模式是西安。兼容性测试方案包括接口测试、模拟不同客户端请求等。

### 在项目设计中，如何平衡了系统安全和性能之间的矛盾？有哪些具体的实践和经验？

平衡系统安全和性能，通过实现安全中间件、访问控制、日志审计等，实践经验包括合理配置安全策略，避免过度加密和授权

### 你认为该项目中最有挑战性的技术问题是什么？你是否解决过类似的问题，有哪些经验可以分享？

最有挑战性的技术问题可能是在保证高并发下的系统稳定性，解决类似问题的经验包括使用分布式架构、限流、熔断、降级等策略。

### 项目需求来自哪里

此项目最核心背景和诉求，是我希望找到一个可以真实锻炼技术应用的场景，并且可以基于此项目的设计、开发、上线、运维等一系列操作，提高编程思维和落地能力。而此项目只是一个载体，在项目中我运用到的微信对接、登录鉴权、异步接口、下单支付、异步发货、账户管理等场景可以运用到其他任何一个项目中使用。所以我选择开发这样的一个项目。

并且这个项目运用到了DDD分层架构，领域驱动设计实现，对于各个场景都遵守了设计原则和设计模式，解决各类复杂场景的实现。如：生成式服务流程中运用到了模板模式、策略模式、工厂模式，解决对话过程中所需的规则过滤、模型校验、账户状态、账户扣减等开发流程。

通过以上项目的学习，我锻炼到了相关项目所用到的核心技术使用，架构设计和落地实现。而此项目的学习，也为我在以后工作中解决实际场景问题，打下了牢固的基础。

### 项目为什么使用DDD架构，有什么好处

首先是DDD架构的结构分层更加清晰，与MVC相比避免了PO、VO对象被乱用可能。而这也是在DDD中将行为和逻辑封装到了一个领域内进行处理，也就是常说的充血模型结构。这样的结构方式，可以更好的做到业务流程松耦合，功能实现高内聚。

在这个项目中，按照业务流程涵盖了鉴权登录、OpenAI、下单、微信，4大核心场景，这四个核心场景恰好是四个领域，每个领域可以独立开发设计，再通过上层进行编排使用。如果是小项目，直接由trigger触发器层进行编排，如果是大型复杂项目可以增加case编排层，再由trigger层调用（层之间是防腐，防腐避免了对象和服务被污染）。

### 充血模型和贫血模型分别适合什么场景

在DDD架构中，充血模型，主要的价值在于解决具有生命周期的流程。如生成式对话、商品下单支付、用户登录授权等流程。因为这些流程中具有较复杂的场景模型和唯一ID，所以采用充血模型结构，会很合适的将状态和行为封装到同一的领域中进行聚合开发实现。这样的实现方式，也为之后的扩展、迭代、维护做好了良好的基建，避免工程过于腐化。

### 这个项目部署上线了吗，怎么部署的，部署后占用内存情况如何，请描述下。

部署了Prometheus+Grafana监控组件，以及配置了前端百度统计PV、UV。部署的方式是先购买了一个2c4g 5M宽带的云服务器以及申请备案了域名，之后在前后端应用配置了Dockerfile打包镜像推送到DockerHub，之后编写docker compose含环境（Mysql、redis等）脚本，在云服务器执行部署。因为本项目的登录采用了公众号登录，所以在部署后把服务端接口地址，配置到公众号控制台进行验签和接收验证码登录。

整个项目部署完成后，占用了53%~61%的服务器内存，Tomcat配置了最大连接数是250，OpenAI调用接口熔断为6秒【OpenAI有时候会超时】，同时在前端也配置了50秒主动断开。压测过接口的响应，按照目前的服务器可以压测到50~80TPS，日常测试接口响应平均值在3~10秒，这些数据来自Grafana监控的显示

这里为什么后端有超时熔断，前端也加了50秒超时主动断开，因为OpenAI接口的响应是ResponseBodyEmitter异步应答，当返回一个数据块后，代表已经有响应，则不会计算服务端的超时。但第一次应答后，后面的数据如果卡住了，仍可能一直无应答。所以前端加上主动超时断开会更加稳妥。【一般情况下，1~5秒，服务端开始应答】、

### 你的项目对接了哪些OpenAI？怎么对接的

在项目的开发阶段，对接了ChatGPT和国内的ChatGLM，两款AI产品，对接的方式是采用会话模型（MyBatis Session）流程，使用retrofit2+OkHttp3框架，封装OpenAI HTTP接口。提供统一的出入参，并使用工厂模式，构建OpenAI启动阶段所需的验证、日志、执行过程。并最终对外提供OpenAI会话服务。

### 你的项目是前后端分离的，接口跨域是怎么做的

Web跨域（CORS）是一种安全机制，用于限制一个域下的文档或脚本如何与另一个源的资源进行交互，这是一个由浏览器强制执行的安全特性，旨在防止恶意网站读取或修改另一个网站的数据，这种攻击通常被称为“跨站脚本”（XSS）。

所以，我在项目中，通过配置@CrossOrigin注解来解决跨域问题，开发阶段`Access-Control-Allow-Origin: *`、上线阶段`Access-Control-Allow-Origin:http://xxx.xx`

### 请描述下，商品下单支付场景，以及怎么保证的补偿

下单支付场景在整个项目中是一块非常核心的流程，首先是系统设计采用了DDD架构，对商品下单按照业务流程拆解出来了单独的领域模块。在设计实现上，以购物车为下单入参的实体对象，出参为支付单实体，保存的是订单的聚合信息。

因为本身下单是一个较为复杂的流程，所以在编码上采用了模板模式，定义出下单的标准过程。商品下单的流程首先需要查询是否存在`已下单未支付`和`已下单但无支付单`的订单，对这样两种订单分别进行处理。

已下单未支付，在有效期内未关单的直接返回给用户直接支付。

已下单但无支付单的，则表用支付宝创建支付订单，保存库表记录后返回给前端用户进行支付。

此外的流程则直接执行购物车商品ID查询，组装聚合订单数据，创建支付单，保存库表记录和返回给用户。用户支付完后，接收支付回调消息，推送（MQ/Redis发布订阅/Guava事件）信息，由系统中trigger模块下的监听处理接收支付成功消息，完成商品的发货处理。

这里可能发生的掉单情况，接收回调消息处理失败。则由定时任务扫描库表订单，超时15分钟未支付的订单，查询支付平台（支付宝沙箱）是否已支付，如果支付则发送事件消息后走后续的补货流程。另外，如果超过15分钟以上未支付则进行本地关单，不对支付平台关单（支付平台有自己的时间），这样可以让用户的体验更加舒服，用户超时后支付，仍可以走后续的发货流程。但如果用户刷新页面，则获取创建新的支付单。

### 你的订单是一个频繁使用的表，那么库表中有哪些核心字段，索引有哪些？

有用户ID（用的公众号创建的openid）、商品ID、商品名称、商品金额、订单ID、下单时间、订单状态、支付单类型（微信、支付宝）、支付单号、支付时间、交易单号、交易状态等。表中对订单ID、用户唯一创建了唯一索引，对订单状态和订单时间创建组合索引（提高扫描效率）

### OpenAI的体验，都是渐进式展示的，这块后端使用了扫描接口形式?

这部分是使用SpringBoot应用提供的HTTP接口，返回的是ResponseBodyEmitter异步请求处理协议。他是SpringMVC所提供的一个异步响应，当你控制器中返回一个ResponseBodyEmitter实例时，Spring MVC会开启一个异步请求处理，这样就可以在单个请求中发送多个OpenAI应答数据块。这样的应答方式非常适合OpenAI这样需要大批量应答数据的场景。此外，因为服务端的接口需要Nginx转发，所以在Nginx端还需要关闭分块解码（chunked_transfer_encoding）、关闭转发缓冲（proxy_buffering）、关闭应答缓存（proxy_cache），这样最终才能是一个渐进式的展示效果。

### 你的项目中对接了ChatGPT和ChatGLM两个模型，那么使用了什么设计模式？

在项目中定义了一个通信渠道策略接口，接口方法返回统一的格式数据。两款OpenAI服务分别实现自己接口处理。之后两个实现的策略模式注入到Map中，key是一个枚举值。当前端选择不同的模型进行回答时，则根据模型的枚举值从Map中选出对应的策略处理类。这样即使是后续扩展其他的OpenAI服务也非常容易扩展。

### 你在项目中还有支付购买的次数，那么就应会有额度扣减、账户的校验、还有模型的使用类型，这些是怎么实现的。

其实除了账户、额度、模型、还有敏感词过滤，在这部分实现中我定义了统一的ILogicFilter过滤接口，分别实现不同的过滤请求，在通过工厂的封装，装配上不同的过滤规则类。用户进行回答后，会对用户的信息进行分别校验。这部分也就是整体OpenAI应答中使用的模板、工厂、策略三个设计模式。另外像是这样的调用验证方式，也可以使用责任链的方式处理。

之后说一下敏感词，敏感词对接了通用的敏感词库，但校验的过于严格同时不是动态的，所以可能不准。后来又对接了云服务厂商的敏感词过滤服务+图片审核服务。可以配置广告、舆情、敏感词类都可以配置过滤。

### 你是怎么处理异常的

项目中对接OpenAI接口、数据库、缓存、下单调用等，是有可能出现超时、数据接口更新、数据库连接、缓存数据问题等异常，这些异常属于功能异常，是在每个领域模型内可能发生的问题情况。为了让异常保持统一，具备业务语义，所以在types层定义业务异常类ChatGLMException和对应的异常码枚举【0000成功、0001失败、0002非法参数、0003未登录、0E001商品下架等异常码】这样就可以标准化返回给前端，针对不同的异常进行信息展示。

### 对于返回给前端的接口，返回从出参结果怎么定义的？

定义了一个`Response<T>`添加code、info、data（枚举类型）参数，统一封装返回结果，这是一个通用设计，应该不止是我开发的系统，在我去F12看各个网站时候，也都是这样统一标准的接口出参。

### 公众号里面可以对接OpenAI自动服务吗

技术上可以对接，在公众号配置完接口地址验签成功后，就可以接收用户在公众号发送的消息，之后根据消息内容请求OpenAI同步响应接口（也可以是异步接口Future封装）。但这里要注意一点，我是用个人公众号开发。不能直接根据用户ID给用户返回信息，只能随着请求一次返沪。

那么就有可能用户提问后，我调用OpenAI接口，因为会需要较长的时间返回数据，超过公众号5秒限制，就会得不到数据，所以这块利用公众号的回调机制，5秒+3次，我在后端使用了countDownLatch进行等待，每次都消耗5秒，让公众号在第三次从我的后端获取数据返回。这样可以最大限度保证，一次提问就可以获取到数据。如果仍没有获取到数据，则提示给用户需要再次提问同样的问题。这个时候我会以问题作为key，获取OpenAI的结果缓存回答给用户。

### 应用程序使用了什么数据库连接池，连接数配置如何？

配置了SpringBoot默认提供的hikari连接池，我之前也有压测过c3p0,dbcp,druid,hikari这四款连接池，其中hikari是效率最高也是最稳定的，dbcp相对较差，但如果不适用连接池会更差。

在我的应用中，配置最小空闲数（minimum-idle）是15个，最大连接数(maxinmum-pool-size)是25个。本身下单接口的平均响应时间是48毫秒，那么按照我的这个连接池配置，约为520.75事务/秒，这个量级是非常够用的。如果不够，可以适当调整连接数大小。

### 是否支持分布式部署

一个项目是否支持分布式部署的标识在于它的数据处理是基于单体的还是基于分布式架构的，当一台机器宕机，用户在访问时候轮询到下一台机器是否还可以保证业务进行，详实这套项目使用的数据库存储用户、账单、商品、下单，在Redis中存放用户的登录鉴权，那么就可以基于Nginx轮询的方式配置多态应用的负载，以此支持分布式架构。

### 登录这个业务过程是什么样。

企业公众号登录的模型是通过AccessToken创建二维码凭证ticket，并让前端根据凭证创建带参登录的二维码。当用户扫码后，对接公众号的服务端会收到回调信息，里面包含了ticket、openid，那么这个时候就可以创建出jwt token，前端页面不断通过ticket轮询接口获取绑定登录信息即可。